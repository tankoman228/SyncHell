#!/bin/bash

echo "–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä MP3 –≤ OGG –¥–ª—è SFML"
echo "======================================"

# –ï—Å–ª–∏ –µ—Å—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
if [ $# -eq 1 ]; then
    input_file="$1"
    echo "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–∞–π–ª –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–∞: $input_file"
elif [ $# -eq 2 ]; then
    input_file="$1"
    output_file="$2"
    echo "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: $input_file"
    echo "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: $output_file"
else
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞
    echo "–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ MP3 —Ñ–∞–π–ª –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å:"
    read -r input_file
fi

# –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤–æ–∫—Ä—É–≥ –ø—É—Ç–∏
input_file=$(echo "$input_file" | sed -e "s/^['\"]//" -e "s/['\"]$//")
if [ -n "$output_file" ]; then
    output_file=$(echo "$output_file" | sed -e "s/^['\"]//" -e "s/['\"]$//")
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª
if [ ! -f "$input_file" ]; then
    echo "–û—à–∏–±–∫–∞: –§–∞–π–ª '$input_file' –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    exit 1
fi

# –ï—Å–ª–∏ –≤—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª –Ω–µ —É–∫–∞–∑–∞–Ω, —Å–æ–∑–¥–∞–µ–º –∏–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
if [ -z "$output_file" ]; then
    output_file="${input_file%.*}.ogg"
fi

# –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ .ogg
if [[ ! "$output_file" =~ \.ogg$ ]]; then
    output_file="${output_file}.ogg"
fi

echo "======================================"
echo "–ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª: $input_file"
echo "–í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: $output_file"
echo "======================================"

echo "–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç, —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å SFML..."
echo "–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è..."

# –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¥–ª—è SFML:
# -ar 44100     - —á–∞—Å—Ç–æ—Ç–∞ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏ 44.1 kHz (—Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è SFML)
# -ac 2         - —Å—Ç–µ—Ä–µ–æ –∑–≤—É–∫
# -c:a libvorbis - –∫–æ–¥–µ–∫ Vorbis
# -q:a 6        - –∫–∞—á–µ—Å—Ç–≤–æ –∑–≤—É–∫–∞ (–æ—Ç 0 –¥–æ 10, 6 - —Ö–æ—Ä–æ—à–∏–π –±–∞–ª–∞–Ω—Å)
# -map_metadata -1 - –Ω–µ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
# -vn           - —Ç–æ–ª—å–∫–æ –∞—É–¥–∏–æ (–±–µ–∑ –≤–∏–¥–µ–æ)

ffmpeg -i "$input_file" \
    -ar 44100 \
    -ac 2 \
    -c:a libvorbis \
    -q:a 6 \
    -map_metadata -1 \
    -vn \
    "$output_file"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
if [ $? -eq 0 ]; then
    echo "======================================"
    echo "‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞
    echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞..."
    if command -v file &> /dev/null; then
        file_info=$(file "$output_file")
        echo "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ: $file_info"
    fi
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∞—É–¥–∏–æ
    if command -v ffprobe &> /dev/null; then
        echo "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∞—É–¥–∏–æ:"
        ffprobe -v error -select_streams a:0 \
            -show_entries stream=codec_name,sample_rate,channels,bit_rate \
            -of default=noprint_wrappers=1:nokey=1 \
            "$output_file" | while read -r line; do
            case $line in
                "vorbis") echo "  –ö–æ–¥–µ–∫: Vorbis" ;;
                "44100") echo "  –ß–∞—Å—Ç–æ—Ç–∞: 44.1 kHz" ;;
                "2") echo "  –ö–∞–Ω–∞–ª—ã: –°—Ç–µ—Ä–µ–æ" ;;
                *) if [[ $line =~ ^[0-9]+$ ]]; then
                       echo "  –ë–∏—Ç—Ä–µ–π—Ç: $((line/1000)) kbps"
                   fi ;;
            esac
        done
    fi
    
    echo "üìÅ –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª: $output_file"
    
    # –°–æ–≤–µ—Ç—ã –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ SFML
    echo "======================================"
    echo "üí° –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ SFML/C++:"
    echo ""
    echo "1. –î–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª –≤ –ø—Ä–æ–µ–∫—Ç"
    echo "2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∑–≤—É–∫:"
    echo "   sf::Music music;"
    echo "   if (!music.openFromFile(\"${output_file##*/}\")) {"
    echo "       // –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏"
    echo "   }"
    echo "3. –ò–ª–∏ –¥–ª—è –∑–≤—É–∫–æ–≤–æ–≥–æ –±—É—Ñ–µ—Ä–∞:"
    echo "   sf::SoundBuffer buffer;"
    echo "   sf::Sound sound;"
    echo "   if (buffer.loadFromFile(\"${output_file##*/}\")) {"
    echo "       sound.setBuffer(buffer);"
    echo "   }"
    
else
    echo "======================================"
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏!"
    echo ""
    echo "–í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:"
    echo "1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ ffmpeg —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
    echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª –Ω–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å"
    echo "3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π MP3 —Ñ–∞–π–ª"
    exit 1
fi
